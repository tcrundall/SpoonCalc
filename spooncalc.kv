##:kivy
#:import Factory kivy.factory.Factory

#:set pad "5dp"
#:set button_group_size_hint 1, 0.75
#:set label_color 1, 1, 1, 1
#:set label_background_color 0.3, 0.7, 0.9, 1
#:set button_spacing "5dp"
#:set toplevel_spacing "15dp"
#:set button_pad "2dp"

#:set font_size_title "40dp"
#:set font_size_heading_1 "24dp"
#:set font_size_heading_2 "18dp"
#:set font_size_button_1 "20dp"
#:set font_size_button_2 "16dp"
#:set font_size_contents "15dp"
#:set container_size_contents "30dp"        # double `font_size_contents`

WindowManager:
    MenuWindow:
    InputWindow:
    LogsWindow:
    PlotWindow:
    ImportWindow:

<MyPopup@Popup>
    title: "Database"
    title_size: font_size_heading_1
    size_hint: 0.8, 0.7
    pos_hint: {"x": 0.1, "top": 0.9}
    BoxLayout:
        orientation: "vertical"
        ScrollView:
            size_hint_y: 0.9
            do_scroll_x: True
            do_scroll_y: True
            Label:
                size_hint_y: 10 
                size_hint_x: 5
                text: root.text
                text_size: self.size
                halign: "left"
                valign: "top"
                id: database_output
                font_size: font_size_contents
                font_name: "RobotoMono-Regular"
        Button:
            size_hint_y: 0.1
            text: "close"
            font_size: font_size_button_1
            on_release: root.dismiss()


<Option@BoxLayout>:
    orientation: "vertical"
    padding: (pad, pad, pad, pad)

<MenuWindow>:
    name: "menu"
    BoxLayout:
        orientation: "vertical"
        size: root.width, root.height
        Label:
            text: "Spoon Calculator!"
            font_size: font_size_title
            size_hint_y: 0.8
        Button:
            text: "Log an activity"
            font_size: font_size_heading_1
            size_hint_y: 0.1
            on_release:
                root.manager.transition.direction = "left"
                app.root.current = "input"
        Button:
            text: "Plot"
            font_size: font_size_heading_1
            size_hint_y: 0.1
            on_release:
                root.manager.transition.direction = "left"
                app.root.current = "plot"
        Button:
            text: "Show logs"
            font_size: font_size_heading_1
            size_hint_y: 0.1
            on_release:
                # Factory.MyPopup().open()
                root.manager.transition.direction = "left"
                app.root.current = "logs"
        
        Button:
            text: "Export logs"
            font_size: font_size_heading_1
            size_hint_y: 0.1
            on_release:
                root.export_database()
        
        Button:
            text: "Import logs"
            font_size: font_size_heading_1
            size_hint_y: 0.1
            on_release:
                root.manager.transition.direction = "left"
                app.root.current = "import"
        
<ImportWindow>:
    name: "import"
    BoxLayout:
        orientation: "vertical"
        Label:
            size_hint: 1, 0.1
        BoxLayout:
            size_hint: 1, 0.1
            orientation: "horizontal"
            Label:
                size_hint: None, None
                text: "Import filename: "
                size: self.texture_size
                height: container_size_contents
                font_size: font_size_contents
            TextInput:
                id: external_file
                size_hint: 1, None
                height: container_size_contents
                font_size: font_size_contents
                text: "spoon-output.csv"
        Label:
            size_hint: 1, 0.7
        BoxLayout:
            size_hint: 1, 0.1
            orientation: "horizontal"
            Button:
                text: "Cancel"
                font_size: font_size_button_1
                on_release:
                    root.manager.transition.direction = "right"
                    app.root.current = "menu"
            Button:
                text: "Import"
                font_size: font_size_button_1
                on_release:
                    root.on_import_press(external_file.text)
                    root.manager.transition.direction = "right"
                    app.root.current = "menu"


<InputWindow>:
    name: "input"
    BoxLayout:
        orientation: "vertical"
        spacing: toplevel_spacing
        BackgroundLabel:
            text: f"{root.title}"
            font_size: font_size_title
            color: label_color
        TextInput:
            text: "Activity name"
            font_size: font_size_heading_1
            id: activity_name
            multiline: False
            size_hint: 1, 0.3
        BoxLayout:
            orientation: "horizontal"
            # spacing: toplevel_spacing
            Option:
                orientation: "vertical" 
                padding: (pad, pad, pad, pad)
                BackgroundLabel:
                    text: "Cog. Load"
                    font_size: font_size_heading_2
                    color: label_color
                BoxLayout:
                    orientation: "horizontal"
                    # spacing: button_spacing
                    ToggleButton:
                        id: cog_low
                        text: "Low"
                        font_size: font_size_button_2
                        on_state: root.on_toggle(self, "cog")
                    ToggleButton:
                        id: cog_mid
                        text: "Mid"
                        on_state: root.on_toggle(self, "cog")
                        font_size: font_size_button_2
                        state: "down"
                    ToggleButton:
                        id: cog_high
                        text: "High"
                        font_size: font_size_button_2
                        on_state: root.on_toggle(self, "cog")
            Option:
                BackgroundLabel:
                    text: "Phys. Load"
                    color: label_color
                    font_size: font_size_heading_2
                BoxLayout:
                    orientation: "horizontal"
                    ToggleButton:
                        id: phys_low
                        text: "Low"
                        font_size: font_size_button_2
                        on_state: root.on_toggle(self, "phys")
                    ToggleButton:
                        id: phys_mid
                        text: "Mid"
                        font_size: font_size_button_2
                        on_state: root.on_toggle(self, "phys")
                        state: "down"
                    ToggleButton:
                        id: phys_high
                        text: "High"
                        font_size: font_size_button_2
                        on_state: root.on_toggle(self, "phys")
        Option:
            orientation: "vertical"
            BackgroundLabel:
                text: f"Duration: {root.duration_display}"
                font_size: font_size_heading_2
                color: label_color
            BoxLayout:
                orientation: "horizontal"
                ToggleButton:
                    id: dur_015
                    text: "0:15"
                    font_size: font_size_button_2
                    on_state: root.on_toggle_duration(self)
                ToggleButton:
                    id: dur_030
                    text: "0:30"
                    font_size: font_size_button_2
                    on_state: root.on_toggle_duration(self)
                ToggleButton:
                    id: dur_1
                    text: "1"
                    font_size: font_size_button_2
                    on_state: root.on_toggle_duration(self)
                    state: "down"
                ToggleButton:
                    id: dur_2
                    text: "2"
                    font_size: font_size_button_2
                    on_state: root.on_toggle_duration(self)
                ToggleButton:
                    id: dur_4
                    text: "4"
                    font_size: font_size_button_2
                    on_state: root.on_toggle_duration(self)
                # TextInput:
                #     id: dur_custom_text
                #     text: "custom"
                #     multiline: False
                #     on_text_validate: root.on_dur_text_validate(self)
        Option:
            orientation: "vertical"
            BackgroundLabel:
                text: "End Time"
                font_size: font_size_heading_2
                color: label_color
                halign: "left"
            BoxLayout:
                orientation: "horizontal"
                Button:
                    id: -1
                    text: "-1"
                    font_size: font_size_button_2
                    on_press: root.on_end_time_press(self)
                Button:
                    id: -015
                    text: "-0:15"
                    font_size: font_size_button_2
                    on_press: root.on_end_time_press(self)
                BackgroundLabel:
                    color: label_color
                    text: f"{root.end_display}"
                    font_size: font_size_button_2
                Button:
                    id: +015
                    text: "+0:15"
                    on_press: root.on_end_time_press(self)
                    font_size: font_size_button_2
                Button:
                    id: +1
                    text: "+1"
                    on_press: root.on_end_time_press(self)
                    font_size: font_size_button_2
        Option:
            orientation: "vertical"
            BackgroundLabel:
                text: "Energy Level"
                font_size: font_size_heading_2
                id: energy_toggle_label
                color: label_color
            BoxLayout:
                orientation: "horizontal"
                text: "Energy Level"
                id: energy_toggles
                ToggleButton:
                    text: "Low"
                    id: energy_low
                    font_size: font_size_button_2
                    on_state: root.on_toggle(self, "energy")
                ToggleButton:
                    text: "Mid"
                    id: energy_mid
                    font_size: font_size_button_2
                    on_state: root.on_toggle(self, "energy")
                    state: "down"
                ToggleButton:
                    text: "High"
                    id: energy_high
                    font_size: font_size_button_2
                    on_state: root.on_toggle(self, "energy")
        BoxLayout:
            size_hint: 1, 0.5
            orientation: "horizontal"
            Button:
                text: "Cancel"
                font_size: font_size_button_1
                on_release:
                    root.manager.transition.direction = "right"
                    app.root.current = "menu"
            Button:
                text: "Save"
                font_size: font_size_button_1
                on_release:
                    root.on_save_press()
                    root.manager.transition.direction = "right"
                    app.root.current = "menu"

<PlotWindow>:
    name: "plot"
    BoxLayout:
        orientation: "vertical"
        BoxLayout:
            id: graph
            size_hint: 1, 0.9
            padding: 10, 10, 0, 10
        BoxLayout:
            orientation: "horizontal"
            size_hint: 1, 0.1
            Button:
                text: "Back"
                font_size: font_size_button_1
                on_release:
                    root.manager.transition.direction = "right"
                    app.root.current = "menu"


<LogsWindow>:
    name: "logs"
    BoxLayout:
        orientation: "vertical"
        BoxLayout:
            orientation: "horizontal"
            size_hint: 1, 0.1
            Button:
                text: "<--"
                font_size: font_size_title
                size_hint: 0.2, 1
                on_release:
                    logs_display.increment_day()
                    root.update_title(logs_display.current_day)
            Label:
                text: root.title
                id: logs_title
                font_size: font_size_title
                size_hint: 0.6, 1
            Button:
                text: "-->"
                font_size: font_size_title
                size_hint: 0.2, 1
                on_release:
                    logs_display.decrement_day()
                    root.update_title(logs_display.current_day)
        ScrollView:
            size_hint: 1, 0.8
            do_scroll_y: True
            do_scroll_x: True
            StackedLogsLayout:
                id: logs_display
                size_hint: 1, None
                height: self.minimum_height

        BoxLayout:
            orientation: "horizontal"
            size_hint: 1, 0.1
            Button:
                text: "Back"
                font_size: font_size_button_1
                on_release:
                    root.manager.transition.direction = "right"
                    app.root.current = "menu"

            Button:
                text: "Delete"
                font_size: font_size_button_1
                on_release:
                    logs_display.delete_entry()


<BackgroundColor@Widget>
    background_color: 1, 1, 1, 1
    canvas.before:
        Color:
            rgba: root.background_color
        Rectangle:
            size: self.size
            pos: self.pos

<BackgroundLabel@Label+BackgroundColor>
    background_color: label_background_color
